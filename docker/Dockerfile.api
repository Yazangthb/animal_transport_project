FROM nvidia/cuda:11.6.2-runtime-ubuntu20.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    python3 python3-pip git wget && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy requirements
COPY docker/requirements.txt /app/requirements.txt

# Install PyTorch for CUDA 11.6
RUN pip3 install torch==2.0.1+cu116 torchvision==0.15.2+cu116 torchaudio==2.0.2 \
    -f https://download.pytorch.org/whl/cu116/torch_stable.html

# Install remaining packages
RUN pip3 install --no-cache-dir -r requirements.txt

# HuggingFace cache
ENV HF_HOME=/app/hf_cache

COPY api /app/api
COPY models /app/models

# Environment defaults
ENV VLM_MODEL_NAME=Qwen/Qwen2.5-VL-7B-Instruct
ENV REASONING_MODEL_NAME=Qwen/Qwen2.5-7B-Instruct
ENV REASONING_LORA_PATH=/app/models/reasoning_lora

EXPOSE 8000

CMD ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000"]
